name: Download Mods and Release

on:
  push:
    branches:
      - main  # Trigger on commits to main branch

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    if: contains(github.event.head_commit.message, '[Release]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set ZIP name and tag
      - name: Set names
        id: vars
        run: |
          DATE=$(date +%Y%m%d)
          SHORT_SHA=${GITHUB_SHA::7}  # shorter SHA for tag
          ZIP_NAME="mods-$DATE-$SHORT_SHA.zip"
          TAG_NAME="mods-$DATE"       # Tag without SHA
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          # Get commit message for description
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV

      - name: Create mods folder
        run: mkdir -p mods

      - name: Download mods
        run: |
          while IFS= read -r url; do
            url="${url#"${url%%[![:space:]]*}"}"
            url="${url%"${url##*[![:space:]]}"}"
            if [[ -z "$url" || "$url" == \#* ]]; then
              continue
            fi
            echo "Downloading $url..."
            curl -L -o "mods/$(basename "$url")" "$url"
          done < mod_download_links.txt

      - name: Zip mods
        run: zip -r "${{ env.ZIP_NAME }}" mods

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}   # Name shows the tag
          body: |
            Automated mods release.

            Commit: ${{ github.sha }}
            Commit message: ${{ github.event.head_commit.message }}
          artifacts: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
          token: ${{ secrets.PAT_TOKEN }}
          commit: ${{ github.sha }}
